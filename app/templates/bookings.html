{% extends "layout.html" %}
{% block title %}Réservations{% endblock %}
{% block content %}

<div class="page-head">
  <div>
    <h1>Réservations</h1>
    <div class="muted">
      Trello = source unique • Génération contrat PDF FR / EN / AR
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-n">{{ stats.demandes }}</div><div class="stat-l">Demandes</div></div>
    <div class="stat"><div class="stat-n">{{ stats.reserved }}</div><div class="stat-l">Réservées</div></div>
    <div class="stat"><div class="stat-n">{{ stats.ongoing }}</div><div class="stat-l">En cours</div></div>
    <div class="stat"><div class="stat-n">{{ stats.done }}</div><div class="stat-l">Terminées</div></div>
    <div class="stat"><div class="stat-n">{{ stats.canceled }}</div><div class="stat-l">Annulées</div></div>
  </div>
</div>

<hr>

<!-- ========================= -->
<!-- CRÉATION RÉSERVATION -->
<!-- ========================= -->

<div class="card">
  <h2>Nouvelle réservation</h2>

  <form method="post" action="{{ url_for('bookings.create') }}" class="form-grid">

    <label>Nom client
      <input name="client_name" required>
    </label>

    <label>Téléphone
      <input name="client_phone">
    </label>

    <label>Adresse
      <input name="client_address">
    </label>

    <label>Document ID
      <input name="doc_id">
    </label>

    <label>Permis
      <input name="driver_license">
    </label>

    <label>Véhicule
      <input name="vehicle_name" required>
    </label>

    <label>Plaque
      <input name="vehicle_plate">
    </label>

    <label>Modèle
      <input name="vehicle_model">
    </label>

    <label>VIN
      <input name="vehicle_vin">
    </label>

    <label>Date début
      <input type="datetime-local" name="start_date">
    </label>

    <label>Date fin
      <input type="datetime-local" name="end_date">
    </label>

    <label>Lieu livraison
      <input name="pickup_location">
    </label>

    <label>Lieu restitution
      <input name="return_location">
    </label>

    <label>Prix / jour (DA)
      <input type="number" name="daily_price">
    </label>

    <label>Dépôt (DA)
      <input type="number" name="deposit">
    </label>

    <label>Total (DA)
      <input type="number" name="total_price">
    </label>

    <label>Km départ
      <input type="number" name="km_out">
    </label>

    <label>Km retour
      <input type="number" name="km_in">
    </label>

    <label>Carburant départ
      <input name="fuel_out">
    </label>

    <label>Carburant retour
      <input name="fuel_in">
    </label>

    <label style="grid-column: span 2;">
      Remarques
      <textarea name="notes"></textarea>
    </label>

    <div style="grid-column: span 2;">
      <label><input type="checkbox" name="opt_gps"> GPS</label>
      <label><input type="checkbox" name="opt_driver"> Chauffeur</label>
      <label><input type="checkbox" name="opt_baby_seat"> Siège bébé</label>
    </div>

    <div style="grid-column: span 2;">
      <button class="btn primary">Créer la demande</button>
    </div>

  </form>
</div>

<hr>

<!-- ========================= -->
<!-- LISTES -->
<!-- ========================= -->

{% macro lane(title, items, status) %}
<div class="card">
  <h2>{{ title }} ({{ items|length }})</h2>

  {% for it in items %}
    {% set p = it.payload %}
    <div class="card-line">

      <b>{{ it.name }}</b><br>
      Client : {{ p.client_name or "—" }}<br>
      Véhicule : {{ p.vehicle_name or p.vehicle_model or "—" }}<br>
      Dates : {{ p.start_date }} → {{ p.end_date }}

      <div style="margin-top:6px;">

        {% if status == "demandes" %}
          <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='reserved') }}">
            <button class="btn">Confirmer</button>
          </form>
        {% endif %}

        {% if status == "reserved" %}
          <form method="post" action="{{ url_for('bookings.contract_and_move') }}">
            <input type="hidden" name="card_id" value="{{ it.id }}">
            <select name="lang">
              <option value="fr">FR</option>
              <option value="en">EN</option>
              <option value="ar">AR</option>
            </select>
            <button class="btn primary">Contrat + En cours</button>
          </form>
        {% endif %}

        {% if status == "ongoing" %}
          <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='done') }}">
            <button class="btn">Terminer</button>
          </form>
        {% endif %}

        <a class="btn ghost" target="_blank"
           href="/contracts/{{ it.id }}.pdf?lang=fr">PDF FR</a>
        <a class="btn ghost" target="_blank"
           href="/contracts/{{ it.id }}.pdf?lang=en">PDF EN</a>
        <a class="btn ghost" target="_blank"
           href="/contracts/{{ it.id }}.pdf?lang=ar">PDF AR</a>

      </div>
    </div>
    <hr>
  {% else %}
    <div class="muted">Aucune carte</div>
  {% endfor %}
</div>
{% endmacro %}

{{ lane("Demandes", demandes, "demandes") }}
{{ lane("Réservées", reserved, "reserved") }}
{{ lane("En cours", ongoing, "ongoing") }}
{{ lane("Terminées", done, "done") }}
{{ lane("Annulées", canceled, "canceled") }}

{% endblock %}

