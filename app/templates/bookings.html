{% extends "layout.html" %}
{% block title %}R√©servations{% endblock %}

{% block content %}

<div class="page-head">
  <div>
    <h1>R√©servations</h1>
    <div class="muted">FR / EN / AR ‚Ä¢ Popup sur carte ‚Ä¢ Supprimer = archive Trello</div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-n">{{ stats.demandes }}</div><div class="stat-l">Demandes</div></div>
    <div class="stat"><div class="stat-n">{{ stats.reserved }}</div><div class="stat-l">R√©serv√©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.ongoing }}</div><div class="stat-l">En location</div></div>
    <div class="stat"><div class="stat-n">{{ stats.done }}</div><div class="stat-l">Termin√©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.canceled }}</div><div class="stat-l">Annul√©</div></div>
  </div>
</div>

<div class="grid2">
  <section class="card">
    <div class="card-h">
      <h2>Nouvelle r√©servation</h2>
    </div>

    <form class="form" method="post" action="{{ url_for('bookings.create') }}">
      <div class="form-grid">
        <label>Client <input name="client_name" placeholder="Nom client" required /></label>
        <label>V√©hicule <input name="vehicle_name" placeholder="Nom v√©hicule" required /></label>

        <label>T√©l√©phone <input name="client_phone" placeholder="+213..." /></label>
        <label>Adresse <input name="client_address" placeholder="Adresse..." /></label>

        <label>Document (CNI/Passeport) <input name="doc_id" /></label>
        <label>Permis <input name="driver_license" /></label>

        <label>D√©part (YYYY-MM-DDTHH:MM) <input name="start_date" placeholder="2026-02-20T10:00" /></label>
        <label>Retour (YYYY-MM-DDTHH:MM) <input name="end_date" placeholder="2026-02-26T10:00" /></label>

        <label>Lieu livraison <input name="pickup_location" /></label>
        <label>Lieu restitution <input name="return_location" /></label>

        <label>Plaque <input name="vehicle_plate" /></label>
        <label>Mod√®le <input name="vehicle_model" /></label>

        <label class="span2">Notes <textarea name="notes" rows="3"></textarea></label>
      </div>

      <div class="opts">
        <label><input type="checkbox" name="opt_gps" /> GPS</label>
        <label><input type="checkbox" name="opt_driver" /> Chauffeur</label>
        <label><input type="checkbox" name="opt_baby_seat" /> Si√®ge b√©b√©</label>
      </div>

      <button class="btn btn-primary" type="submit">Cr√©er (Demande)</button>
    </form>
  </section>

  <section class="card">
    <div class="card-h">
      <h2>Aide</h2>
    </div>
    <div class="help">
      <p>‚úÖ Clique sur une carte pour ouvrir le <b>popup</b>.</p>
      <p>‚úÖ FR/EN/AR : boutons de g√©n√©ration PDF.</p>
      <p>‚úÖ Supprimer = <b>archive</b> la carte Trello (pas de perte totale).</p>
      <p>‚úÖ Calendrier : menu √† ajouter dans layout (voir plus bas).</p>
    </div>
  </section>
</div>

<div class="cols">

  {% macro col(title, items, status) %}
  <div class="col">
    <div class="col-h">{{ title }}</div>
    <div class="col-b">
      {% for it in items %}
        {% set p = it.payload %}
        <div class="ticket js-open-modal" data-card-id="{{ it.id }}" data-status="{{ status }}">
          <div class="ticket-title">{{ it.name }}</div>
          <div class="ticket-meta">
            {% if p and p._type == 'booking' %}
              üïí {{ (p.start_date or '') }} ‚Üí {{ (p.end_date or '') }}
            {% endif %}
          </div>

          <div class="ticket-actions" onclick="event.stopPropagation();">

            {% if status == 'demandes' %}
              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='reserved') }}">
                <button class="btn btn-warn" type="submit">Passer en R√©serv√©</button>
              </form>

              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                <button class="btn btn-danger" type="submit">Annuler</button>
              </form>

            {% elif status == 'reserved' %}
              <form method="post" action="{{ url_for('bookings.contract_and_move') }}">
                <input type="hidden" name="card_id" value="{{ it.id }}" />
                <select name="lang" class="select">
                  <option value="fr">FR</option>
                  <option value="en">EN</option>
                  <option value="ar">AR</option>
                </select>
                <button class="btn btn-primary" type="submit">G√©n√©rer + En location</button>
              </form>

              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                <button class="btn btn-danger" type="submit">Annuler</button>
              </form>

            {% elif status == 'ongoing' %}
              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='done') }}">
                <button class="btn btn-ok" type="submit">Terminer</button>
              </form>
            {% endif %}

            <!-- PDF direct -->
            <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=fr" target="_blank">FR</a>
            <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=en" target="_blank">EN</a>
            <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=ar" target="_blank">AR</a>

            <!-- Supprimer -->
            <form method="post" action="{{ url_for('bookings.delete', card_id=it.id) }}" class="js-confirm-delete">
              <button class="btn btn-outline" type="submit">Supprimer</button>
            </form>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endmacro %}

  {{ col("üì• DEMANDES", demandes, "demandes") }}
  {{ col("üìÖ R√âSERV√â", reserved, "reserved") }}
  {{ col("üîë EN LOCATION", ongoing, "ongoing") }}
  {{ col("‚úÖ TERMIN√â", done, "done") }}
  {{ col("‚ùå ANNUL√â", canceled, "canceled") }}

</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-h">
      <div>
        <div class="modal-title" id="modalTitle">D√©tails</div>
        <div class="modal-sub" id="modalSub"></div>
      </div>
      <button class="btn btn-ghost" id="modalClose">‚úï</button>
    </div>

    <div class="modal-b" id="modalBody">
      <div class="skeleton">Chargement‚Ä¶</div>
    </div>

    <div class="modal-f" id="modalFooter"></div>
  </div>
</div>

{% endblock %}

