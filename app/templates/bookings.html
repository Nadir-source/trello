{% extends "layout.html" %}
{% block title %}RÃ©servations{% endblock %}
{% block content %}

<div class="page-head">
  <div>
    <h1>RÃ©servations</h1>
    <div class="muted">Trello = source unique â€¢ Actions rapides â€¢ Modal dÃ©tails â€¢ PDF FR/EN/AR</div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-n">{{ stats.demandes }}</div><div class="stat-l">Demandes</div></div>
    <div class="stat"><div class="stat-n">{{ stats.reserved }}</div><div class="stat-l">RÃ©servÃ©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.ongoing }}</div><div class="stat-l">En cours</div></div>
    <div class="stat"><div class="stat-n">{{ stats.done }}</div><div class="stat-l">TerminÃ©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.canceled }}</div><div class="stat-l">AnnulÃ©</div></div>
  </div>
</div>

<!-- Top tools -->
<div class="toolbar">
  <div class="toolbar-left">
    <div class="searchbox">
      <span class="ico">ğŸ”</span>
      <input id="q" type="search" placeholder="Rechercher: client, vÃ©hicule, tÃ©lÃ©phone, plaque..." />
    </div>

    <select id="statusFilter" class="select">
      <option value="">Tous statuts</option>
      <option value="demandes">Demandes</option>
      <option value="reserved">RÃ©servÃ©</option>
      <option value="ongoing">En cours</option>
      <option value="done">TerminÃ©</option>
      <option value="canceled">AnnulÃ©</option>
    </select>

    <button class="btn btn-ghost" id="btnCompact" type="button" data-mode="compact">Vue compacte</button>
  </div>

  <div class="toolbar-right">
    <button class="btn btn-primary" type="button" data-open="createPanel">+ Nouvelle rÃ©servation</button>
    <button class="btn btn-ghost" type="button" data-open="tipsPanel">â„¹ï¸ Aide</button>
  </div>
</div>

<!-- Panels (collapsible) -->
<div class="grid2">
  <section class="card panel" id="createPanel">
    <div class="card-h">
      <h2>Nouvelle rÃ©servation</h2>
      <button class="btn btn-ghost btn-icon" type="button" data-close="createPanel">âœ•</button>
    </div>

    <form class="form" method="post" action="{{ url_for('bookings.create') }}">
      <div class="form-grid">
        <label>Client <input name="client_name" placeholder="Nom client" required /></label>
        <label>VÃ©hicule <input name="vehicle_name" placeholder="Nom vÃ©hicule" required /></label>

        <label>TÃ©lÃ©phone <input name="client_phone" placeholder="+213..." /></label>
        <label>Adresse <input name="client_address" placeholder="Adresse..." /></label>

        <label>Document (CNI/Passeport) <input name="doc_id" /></label>
        <label>Permis <input name="driver_license" /></label>

        <label>DÃ©part (YYYY-MM-DDTHH:MM) <input name="start_date" placeholder="2026-02-20T10:00" /></label>
        <label>Retour (YYYY-MM-DDTHH:MM) <input name="end_date" placeholder="2026-02-26T10:00" /></label>

        <label>Lieu livraison <input name="pickup_location" /></label>
        <label>Lieu restitution <input name="return_location" /></label>

        <label>Plaque <input name="vehicle_plate" /></label>
        <label>ModÃ¨le <input name="vehicle_model" /></label>

        <label class="span2">Notes <textarea name="notes" rows="3"></textarea></label>
      </div>

      <div class="opts">
        <label><input type="checkbox" name="opt_gps" /> GPS</label>
        <label><input type="checkbox" name="opt_driver" /> Chauffeur</label>
        <label><input type="checkbox" name="opt_baby_seat" /> SiÃ¨ge bÃ©bÃ©</label>
      </div>

      <button class="btn btn-primary" type="submit">CrÃ©er (Demande)</button>
    </form>
  </section>

  <section class="card panel" id="tipsPanel">
    <div class="card-h">
      <h2>Raccourcis</h2>
      <button class="btn btn-ghost btn-icon" type="button" data-close="tipsPanel">âœ•</button>
    </div>
    <div class="help">
      <p>âœ… Clique sur une carte â†’ <b>modal dÃ©tails</b>.</p>
      <p>âœ… Boutons PDF FR/EN/AR.</p>
      <p>âœ… Supprimer = <b>archive</b> Trello.</p>
      <p>âœ… Recherche + filtres en haut.</p>
    </div>
  </section>
</div>

<!-- Kanban pro : scroll horizontal -->
<div class="board" id="board" data-mode="normal">
  {% macro col(title, items, status, badge_class) %}
  <section class="lane" data-lane="{{ status }}">
    <header class="lane-h">
      <div class="lane-title">
        <span class="badge {{ badge_class }}">{{ title }}</span>
        <span class="lane-count">{{ items|length }}</span>
      </div>
      <div class="lane-sub muted">Glisse visuellement â€¢ Actions rapides</div>
    </header>

    <div class="lane-b">
      {% for it in items %}
        {% set p = it.payload %}
        <article class="cardx js-card"
                 data-card-id="{{ it.id }}"
                 data-status="{{ status }}"
                 data-search="{{ (it.name or '')|lower }} {{ (p.client_phone or '')|lower }} {{ (p.vehicle_plate or '')|lower }} {{ (p.vehicle_model or '')|lower }}">
          <div class="cardx-top">
            <div class="cardx-title" title="{{ it.name }}">{{ it.name }}</div>
            <div class="chip chip-status chip-{{ status }}">{{ status }}</div>
          </div>

          <div class="cardx-mid">
            {% if p and p._type == 'booking' %}
              <div class="meta">
                <span class="chip chip-date">ğŸ•’ {{ (p.start_date or '') }} â†’ {{ (p.end_date or '') }}</span>
              </div>
            {% else %}
              <div class="meta"><span class="chip chip-date">ğŸ•’ (dates non renseignÃ©es)</span></div>
            {% endif %}
          </div>

          <!-- Actions rapides -->
          <div class="cardx-actions" onclick="event.stopPropagation();">
            {% if status == 'demandes' %}
              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='reserved') }}">
                <button class="iconbtn" title="Passer en RÃ©servÃ©" type="submit">âœ…</button>
              </form>
              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                <button class="iconbtn danger" title="Annuler" type="submit">âœ–</button>
              </form>
            {% elif status == 'reserved' %}
              <form method="post" action="{{ url_for('bookings.contract_and_move') }}">
                <input type="hidden" name="card_id" value="{{ it.id }}" />
                <select name="lang" class="select select-mini" title="Langue PDF">
                  <option value="fr">FR</option>
                  <option value="en">EN</option>
                  <option value="ar">AR</option>
                </select>
                <button class="iconbtn primary" title="GÃ©nÃ©rer + En location" type="submit">ğŸš€</button>
              </form>

              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                <button class="iconbtn danger" title="Annuler" type="submit">âœ–</button>
              </form>
            {% elif status == 'ongoing' %}
              <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='done') }}">
                <button class="iconbtn ok" title="Terminer" type="submit">ğŸ</button>
              </form>
            {% endif %}

            <a class="iconbtn ghost" title="PDF FR" href="/contracts/{{ it.id }}.pdf?lang=fr" target="_blank">FR</a>
            <a class="iconbtn ghost" title="PDF EN" href="/contracts/{{ it.id }}.pdf?lang=en" target="_blank">EN</a>
            <a class="iconbtn ghost" title="PDF AR" href="/contracts/{{ it.id }}.pdf?lang=ar" target="_blank">AR</a>

            <form method="post" action="{{ url_for('bookings.delete', card_id=it.id) }}" class="js-confirm-delete">
              <button class="iconbtn outline" title="Archiver (Supprimer)" type="submit">ğŸ—‘</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  </section>
  {% endmacro %}

  {{ col("ğŸ“¥ Demandes", demandes, "demandes", "b-blue") }}
  {{ col("ğŸ“… RÃ©servÃ©", reserved, "reserved", "b-violet") }}
  {{ col("ğŸ”‘ En cours", ongoing, "ongoing", "b-cyan") }}
  {{ col("âœ… TerminÃ©", done, "done", "b-green") }}
  {{ col("âŒ AnnulÃ©", canceled, "canceled", "b-red") }}
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-h">
      <div>
        <div class="modal-title" id="modalTitle">DÃ©tails rÃ©servation</div>
        <div class="modal-sub" id="modalSub"></div>
      </div>
      <button class="btn btn-ghost" id="modalClose" type="button">âœ•</button>
    </div>

    <div class="modal-b" id="modalBody">
      <div class="skeleton">Chargementâ€¦</div>
    </div>

    <div class="modal-f" id="modalFooter"></div>
  </div>
</div>

{% endblock %}

