{# app/templates/bookings.html #}
{% extends "layout.html" %}

{% block content %}

<div class="page-head">
  <h2>R√©servations</h2>

  <div class="stats-row">
    <div class="stat neon-cyan"><div class="n">{{ stats.demandes }}</div><div class="l">Demandes</div></div>
    <div class="stat neon-yellow"><div class="n">{{ stats.reserved }}</div><div class="l">R√©serv√©</div></div>
    <div class="stat neon-green"><div class="n">{{ stats.ongoing }}</div><div class="l">En location</div></div>
    <div class="stat neon-blue"><div class="n">{{ stats.done }}</div><div class="l">Termin√©</div></div>
    <div class="stat neon-red"><div class="n">{{ stats.canceled }}</div><div class="l">Annul√©</div></div>
  </div>
</div>

<hr/>

<!-- ‚úÖ CALENDRIER -->
<div class="card calendar-card">
  <div class="calendar-head">
    <h3>Calendrier</h3>
    <div class="muted">Clique un √©v√©nement ‚Üí ouvre le contrat PDF (si dispo).</div>
  </div>
  <div id="calendar"></div>
</div>

<hr/>

<div class="grid-2">
  <div class="card">
    <h3>Nouvelle r√©servation</h3>

    <form method="post" action="{{ url_for('bookings.create') }}" class="form-grid">
      <div class="field">
        <label>Client (nom)</label>
        <input id="client_name" name="client_name" placeholder="Nom client (ex: Nadir)" required />
        <small>Astuce : clique un client √† droite pour remplir automatiquement.</small>
      </div>

      <div class="field">
        <label>V√©hicule (nom)</label>
        <input id="vehicle_name" name="vehicle_name" placeholder="V√©hicule (ex: Livan X3 Pro)" required />
        <small>Astuce : clique un v√©hicule √† droite pour remplir automatiquement.</small>
      </div>

      <div class="field">
        <label>T√©l√©phone client</label>
        <input name="client_phone" placeholder="+213..." />
      </div>

      <div class="field">
        <label>Adresse client</label>
        <input name="client_address" placeholder="Adresse..." />
      </div>

      <div class="field">
        <label>Document (CNI / Passeport)</label>
        <input name="doc_id" placeholder="N¬∞ document" />
      </div>

      <div class="field">
        <label>Permis</label>
        <input name="driver_license" placeholder="N¬∞ permis" />
      </div>

      <div class="field">
        <label>Date/heure d√©part</label>
        <input type="datetime-local" name="start_date" required />
      </div>

      <div class="field">
        <label>Date/heure retour</label>
        <input type="datetime-local" name="end_date" required />
      </div>

      <div class="field">
        <label>Lieu livraison</label>
        <input name="pickup_location" placeholder="A√©roport / Centre ville..." />
      </div>

      <div class="field">
        <label>Lieu restitution</label>
        <input name="return_location" placeholder="A√©roport / Centre ville..." />
      </div>

      <div class="field">
        <label>Plaque v√©hicule</label>
        <input name="vehicle_plate" placeholder="123-AL-456" />
      </div>

      <div class="field">
        <label>Mod√®le v√©hicule</label>
        <input name="vehicle_model" placeholder="Marque + mod√®le" />
      </div>

      <div class="field">
        <label>N¬∞ S√©rie (VIN)</label>
        <input name="vehicle_vin" placeholder="VIN..." />
      </div>

      <div class="field full">
        <label>Notes</label>
        <textarea name="notes" rows="3" placeholder="Notes..."></textarea>
      </div>

      <div class="field full options-row">
        <label>Options</label>
        <div class="opts">
          <label class="chk"><input type="checkbox" name="opt_gps" /> GPS</label>
          <label class="chk"><input type="checkbox" name="opt_driver" /> Chauffeur</label>
          <label class="chk"><input type="checkbox" name="opt_baby_seat" /> Si√®ge b√©b√©</label>
        </div>
      </div>

      <div class="field full">
        <button class="btn btn-primary" type="submit">Cr√©er (Demande)</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>R√©f√©rentiels (pour t‚Äôaider √† remplir vite)</h3>

    <div class="split">
      <div class="mini">
        <h4>Clients disponibles</h4>
        <div class="list">
          {% for c in clients %}
            <button type="button" class="pill pick-client" data-name="{{ c.name }}">{{ c.name }}</button>
          {% else %}
            <div class="muted">Aucun client trouv√© dans Trello.</div>
          {% endfor %}
        </div>
      </div>

      <div class="mini">
        <h4>V√©hicules disponibles</h4>
        <div class="list">
          {% for v in vehicles %}
            <button type="button" class="pill pick-vehicle" data-name="{{ v.name }}">{{ v.name }}</button>
          {% else %}
            <div class="muted">Aucun v√©hicule trouv√© dans Trello.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      Si la liste est vide, v√©rifie dans <b>config.py</b> les IDs <b>LIST_CLIENTS</b> et <b>LIST_VEHICLES</b>.
    </div>
  </div>
</div>

<hr/>

<div class="board">
  <div class="col">
    <div class="col-head">üì• DEMANDES</div>
    {% for b in demandes %}
      <div class="ticket">
        <div class="t-title">{{ b.name }}</div>
        <div class="t-sub">
          {% if b.payload.client_name %}<span>üë§ {{ b.payload.client_name }}</span>{% endif %}
          {% if b.payload.vehicle_name %}<span>üöó {{ b.payload.vehicle_name }}</span>{% endif %}
        </div>
        <div class="t-sub muted">
          {% if b.payload.start_date %}‚è± {{ b.payload.start_date }}{% endif %}
          {% if b.payload.end_date %} ‚Üí {{ b.payload.end_date }}{% endif %}
        </div>

        <div class="actions">
          <form method="post" action="{{ url_for('bookings.move', card_id=b.id, action='reserved') }}">
            <button class="btn btn-small btn-warning" type="submit">Passer en R√©serv√©</button>
          </form>

          <form method="post" action="{{ url_for('bookings.move', card_id=b.id, action='cancel') }}">
            <button class="btn btn-small btn-danger" type="submit">Annuler</button>
          </form>

          <a class="btn btn-small" href="{{ url_for('contracts.contract_pdf', card_id=b.id) }}" target="_blank">
            T√©l√©charger contrat
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty">Aucune demande.</div>
    {% endfor %}
  </div>

  <div class="col">
    <div class="col-head">üìÖ R√âSERV√â</div>
    {% for b in reserved %}
      <div class="ticket">
        <div class="t-title">{{ b.name }}</div>
        <div class="t-sub">
          {% if b.payload.client_name %}<span>üë§ {{ b.payload.client_name }}</span>{% endif %}
          {% if b.payload.vehicle_name %}<span>üöó {{ b.payload.vehicle_name }}</span>{% endif %}
        </div>

        <div class="actions">
          <form method="post" action="{{ url_for('bookings.contract_and_move', card_id=b.id) }}">
            <button class="btn btn-small btn-primary" type="submit">G√©n√©rer contrat + En location</button>
          </form>

          <form method="post" action="{{ url_for('bookings.move', card_id=b.id, action='cancel') }}">
            <button class="btn btn-small btn-danger" type="submit">Annuler</button>
          </form>

          <a class="btn btn-small" href="{{ url_for('contracts.contract_pdf', card_id=b.id) }}" target="_blank">
            T√©l√©charger contrat
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty">Aucune r√©servation.</div>
    {% endfor %}
  </div>

  <div class="col">
    <div class="col-head">üîë EN LOCATION</div>
    {% for b in ongoing %}
      <div class="ticket">
        <div class="t-title">{{ b.name }}</div>
        <div class="t-sub">
          {% if b.payload.client_name %}<span>üë§ {{ b.payload.client_name }}</span>{% endif %}
          {% if b.payload.vehicle_name %}<span>üöó {{ b.payload.vehicle_name }}</span>{% endif %}
        </div>

        <div class="actions">
          <form method="post" action="{{ url_for('bookings.move', card_id=b.id, action='done') }}">
            <button class="btn btn-small btn-success" type="submit">Terminer</button>
          </form>

          <form method="post" action="{{ url_for('bookings.move', card_id=b.id, action='cancel') }}">
            <button class="btn btn-small btn-danger" type="submit">Annuler</button>
          </form>

          <a class="btn btn-small" href="{{ url_for('contracts.contract_pdf', card_id=b.id) }}" target="_blank">
            Contrat
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty">Aucune location en cours.</div>
    {% endfor %}
  </div>

  <div class="col">
    <div class="col-head">‚úÖ TERMIN√â</div>
    {% for b in done %}
      <div class="ticket">
        <div class="t-title">{{ b.name }}</div>
        <div class="t-sub muted">Termin√©</div>
        <div class="actions">
          <a class="btn btn-small" href="{{ url_for('contracts.contract_pdf', card_id=b.id) }}" target="_blank">
            Contrat
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty">Aucun termin√©.</div>
    {% endfor %}
  </div>

  <div class="col">
    <div class="col-head">‚ùå ANNUL√â</div>
    {% for b in canceled %}
      <div class="ticket">
        <div class="t-title">{{ b.name }}</div>
        <div class="t-sub muted">Annul√©</div>
      </div>
    {% else %}
      <div class="empty">Aucun annul√©.</div>
    {% endfor %}
  </div>
</div>

<!-- ‚úÖ FullCalendar (CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  // ‚úÖ helper : click client/vehicle pills -> remplit inputs
  document.querySelectorAll(".pick-client").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = btn.getAttribute("data-name") || "";
      const inp = document.getElementById("client_name");
      if (inp) inp.value = v;
    });
  });
  document.querySelectorAll(".pick-vehicle").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = btn.getAttribute("data-name") || "";
      const inp = document.getElementById("vehicle_name");
      if (inp) inp.value = v;
    });
  });

  // ‚úÖ calendrier
  const events = {{ calendar_events | tojson }};

  function statusClass(status){
    if(status === "demandes") return "fc-demandes";
    if(status === "reserved") return "fc-reserved";
    if(status === "ongoing") return "fc-ongoing";
    if(status === "done") return "fc-done";
    if(status === "canceled") return "fc-canceled";
    return "";
  }

  document.addEventListener("DOMContentLoaded", function () {
    const el = document.getElementById("calendar");
    if (!el) return;

    const calendar = new FullCalendar.Calendar(el, {
      initialView: "dayGridMonth",
      height: "auto",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      navLinks: true,
      nowIndicator: true,
      eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      events: events.map(e => ({
        ...e,
        classNames: [statusClass((e.extendedProps||{}).status)]
      })),
      eventClick: function(info){
        // ouvre le contrat PDF en nouvel onglet si url pr√©sent
        if (info.event.url) {
          window.open(info.event.url, "_blank");
          info.jsEvent.preventDefault();
        }
      }
    });

    calendar.render();
  });
</script>

<style>
  .page-head{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
  .stats-row{display:flex;gap:10px;flex-wrap:wrap}
  .stat{padding:10px 12px;border:1px solid rgba(255,255,255,.15);border-radius:14px;min-width:110px}
  .stat .n{font-size:22px;font-weight:700}
  .stat .l{font-size:12px;opacity:.8}
  .neon-cyan{box-shadow:0 0 10px rgba(0,255,255,.12)}
  .neon-yellow{box-shadow:0 0 10px rgba(255,255,0,.10)}
  .neon-green{box-shadow:0 0 10px rgba(0,255,0,.10)}
  .neon-blue{box-shadow:0 0 10px rgba(0,140,255,.10)}
  .neon-red{box-shadow:0 0 10px rgba(255,0,0,.10)}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:1100px){.grid-2{grid-template-columns:1fr}}

  .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;background:rgba(255,255,255,.02)}
  .calendar-card{padding:14px}
  .calendar-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
  #calendar{border-radius:14px;overflow:hidden}

  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field.full{grid-column:1/-1}
  input,textarea{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.15);color:inherit}
  small{opacity:.75}
  .options-row .opts{display:flex;gap:14px;flex-wrap:wrap}
  .chk{display:inline-flex;align-items:center;gap:8px;margin-right:12px}

  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.split{grid-template-columns:1fr}}
  .mini{border:1px dashed rgba(255,255,255,.18);border-radius:14px;padding:10px}
  .list{display:flex;flex-wrap:wrap;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;opacity:.95;background:rgba(0,0,0,.10);cursor:pointer}
  .pill:hover{filter:brightness(1.08)}
  .muted{opacity:.7}

  .board{display:grid;grid-template-columns:repeat(5, 1fr);gap:10px;align-items:start}
  @media(max-width:1400px){.board{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:800px){.board{grid-template-columns:1fr}}
  .col{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:10px}
  .col-head{font-weight:700;margin-bottom:8px}
  .ticket{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px;margin-bottom:8px;background:rgba(255,255,255,.03)}
  .t-title{font-weight:700}
  .t-sub{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;margin-top:4px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);text-decoration:none;color:inherit;background:rgba(0,0,0,.12);cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn-small{padding:6px 9px;border-radius:10px;font-size:12px}
  .btn-primary{background:rgba(0,140,255,.18);border-color:rgba(0,140,255,.30)}
  .btn-warning{background:rgba(255,200,0,.16);border-color:rgba(255,200,0,.28)}
  .btn-success{background:rgba(0,200,120,.16);border-color:rgba(0,200,120,.28)}
  .btn-danger{background:rgba(255,0,70,.14);border-color:rgba(255,0,70,.26)}
  .empty{opacity:.7;padding:10px}

  /* ‚úÖ couleurs des events FullCalendar via classNames */
  .fc .fc-event.fc-demandes { border-color: rgba(0,255,255,.45) !important; background: rgba(0,255,255,.12) !important; }
  .fc .fc-event.fc-reserved { border-color: rgba(255,200,0,.50) !important; background: rgba(255,200,0,.12) !important; }
  .fc .fc-event.fc-ongoing { border-color: rgba(0,200,120,.55) !important; background: rgba(0,200,120,.12) !important; }
  .fc .fc-event.fc-done { border-color: rgba(0,140,255,.55) !important; background: rgba(0,140,255,.12) !important; }
  .fc .fc-event.fc-canceled { border-color: rgba(255,0,70,.55) !important; background: rgba(255,0,70,.12) !important; }

  /* Dark-ish calendar */
  .fc { color: inherit; }
  .fc .fc-scrollgrid, .fc .fc-scrollgrid td, .fc .fc-scrollgrid th { border-color: rgba(255,255,255,.08) !important; }
  .fc .fc-toolbar-title { color: #e9eefc; }
  .fc .fc-button { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); }
  .fc .fc-button:hover { filter: brightness(1.1); }
  .fc .fc-daygrid-day-number { color: rgba(233,238,252,.75); }
</style>

{% endblock %}

