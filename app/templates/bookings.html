{% extends "layout.html" %}
{% block title %}R√©servations{% endblock %}

{% block content %}

<div class="page-head">
  <div>
    <h1>R√©servations</h1>
    <div class="muted">FR / EN / AR ‚Ä¢ Popup sur carte ‚Ä¢ Supprimer = archive Trello</div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-n">{{ stats.demandes }}</div><div class="stat-l">Demandes</div></div>
    <div class="stat"><div class="stat-n">{{ stats.reserved }}</div><div class="stat-l">R√©serv√©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.ongoing }}</div><div class="stat-l">En location</div></div>
    <div class="stat"><div class="stat-n">{{ stats.done }}</div><div class="stat-l">Termin√©</div></div>
    <div class="stat"><div class="stat-n">{{ stats.canceled }}</div><div class="stat-l">Annul√©</div></div>
  </div>
</div>

<!-- ‚úÖ Onglets -->
<div class="tabs">
  <button class="tab active" data-tab="kanban">Kanban</button>
  <button class="tab" data-tab="calendar">Calendrier</button>
</div>

<!-- ========================= -->
<!-- TAB: KANBAN -->
<!-- ========================= -->
<div class="tab-panel" data-panel="kanban">

  <div class="grid2">
    <section class="card">
      <div class="card-h">
        <h2>Nouvelle r√©servation</h2>
      </div>

      <form class="form" method="post" action="{{ url_for('bookings.create') }}">
        <div class="form-grid">
          <label>Client <input name="client_name" placeholder="Nom client" required /></label>
          <label>V√©hicule <input name="vehicle_name" placeholder="Nom v√©hicule" required /></label>

          <label>T√©l√©phone <input name="client_phone" placeholder="+213..." /></label>
          <label>Adresse <input name="client_address" placeholder="Adresse..." /></label>

          <label>Document (CNI/Passeport) <input name="doc_id" /></label>
          <label>Permis <input name="driver_license" /></label>

          <label>D√©part (YYYY-MM-DDTHH:MM) <input name="start_date" placeholder="2026-02-20T10:00" /></label>
          <label>Retour (YYYY-MM-DDTHH:MM) <input name="end_date" placeholder="2026-02-26T10:00" /></label>

          <label>Lieu livraison <input name="pickup_location" /></label>
          <label>Lieu restitution <input name="return_location" /></label>

          <label>Plaque <input name="vehicle_plate" /></label>
          <label>Mod√®le <input name="vehicle_model" /></label>

          <label class="span2">Notes <textarea name="notes" rows="3"></textarea></label>
        </div>

        <div class="opts">
          <label><input type="checkbox" name="opt_gps" /> GPS</label>
          <label><input type="checkbox" name="opt_driver" /> Chauffeur</label>
          <label><input type="checkbox" name="opt_baby_seat" /> Si√®ge b√©b√©</label>
        </div>

        <button class="btn btn-primary" type="submit">Cr√©er (Demande)</button>
      </form>
    </section>

    <section class="card">
      <div class="card-h">
        <h2>Raccourcis</h2>
      </div>
      <div class="help">
        <p>‚úÖ Clique sur une carte pour ouvrir le <b>popup</b>.</p>
        <p>‚úÖ FR/EN/AR : boutons de g√©n√©ration PDF.</p>
        <p>‚úÖ Supprimer = <b>archive</b> la carte Trello.</p>
        <p>‚úÖ Onglet Calendrier : clic sur un item = popup carte.</p>
      </div>
    </section>
  </div>

  <div class="cols">

    {% macro col(title, items, status) %}
    <div class="col">
      <div class="col-h">{{ title }}</div>
      <div class="col-b">
        {% for it in items %}
          {% set p = it.payload %}
          <div class="ticket js-open-modal" data-card-id="{{ it.id }}" data-status="{{ status }}">
            <div class="ticket-title">{{ it.name }}</div>
            <div class="ticket-meta">
              {% if p and p._type == 'booking' %}
                üïí {{ (p.start_date or '') }} ‚Üí {{ (p.end_date or '') }}
              {% endif %}
            </div>

            <div class="ticket-actions" onclick="event.stopPropagation();">

              {% if status == 'demandes' %}
                <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='reserved') }}">
                  <button class="btn btn-warn" type="submit">Passer en R√©serv√©</button>
                </form>

                <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                  <button class="btn btn-danger" type="submit">Annuler</button>
                </form>

              {% elif status == 'reserved' %}
                <form method="post" action="{{ url_for('bookings.contract_and_move') }}">
                  <input type="hidden" name="card_id" value="{{ it.id }}" />
                  <select name="lang" class="select">
                    <option value="fr">FR</option>
                    <option value="en">EN</option>
                    <option value="ar">AR</option>
                  </select>
                  <button class="btn btn-primary" type="submit">G√©n√©rer + En location</button>
                </form>

                <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='canceled') }}">
                  <button class="btn btn-danger" type="submit">Annuler</button>
                </form>

              {% elif status == 'ongoing' %}
                <form method="post" action="{{ url_for('bookings.move', card_id=it.id, action='done') }}">
                  <button class="btn btn-ok" type="submit">Terminer</button>
                </form>
              {% endif %}

              <!-- PDF direct -->
              <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=fr" target="_blank">FR</a>
              <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=en" target="_blank">EN</a>
              <a class="btn btn-ghost" href="/contracts/{{ it.id }}.pdf?lang=ar" target="_blank">AR</a>

              <!-- Supprimer -->
              <form method="post" action="{{ url_for('bookings.delete', card_id=it.id) }}" class="js-confirm-delete">
                <button class="btn btn-outline" type="submit">Supprimer</button>
              </form>

            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endmacro %}

    {{ col("üì• DEMANDES", demandes, "demandes") }}
    {{ col("üìÖ R√âSERV√âES", reserved, "reserved") }}
    {{ col("üîë EN COURS", ongoing, "ongoing") }}
    {{ col("‚úÖ TERMIN√âES", done, "done") }}
    {{ col("‚ùå ANNUL√âES", canceled, "canceled") }}

  </div>
</div>

<!-- ========================= -->
<!-- TAB: CALENDAR -->
<!-- ========================= -->
<div class="tab-panel" data-panel="calendar" style="display:none;">
  <div class="card">
    <div class="card-h" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Calendrier</h2>
      <button class="btn btn-ghost" id="calRefresh" type="button">‚Üª Rafra√Æchir</button>
    </div>
    <div id="calendarList"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-h">
      <div>
        <div class="modal-title" id="modalTitle">D√©tails</div>
        <div class="modal-sub" id="modalSub"></div>
      </div>
      <button class="btn btn-ghost" id="modalClose">‚úï</button>
    </div>

    <div class="modal-b" id="modalBody">
      <div class="skeleton">Chargement‚Ä¶</div>
    </div>

    <div class="modal-f" id="modalFooter"></div>
  </div>
</div>

<!-- ‚úÖ mini CSS (au cas o√π) -->
<style>
  .tabs{display:flex;gap:10px;margin:12px 0 18px}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:inherit;cursor:pointer}
  .tab.active{outline:2px solid rgba(59,130,246,.35);background:rgba(59,130,246,.08)}
  .cal-day{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin:10px 0;background:rgba(255,255,255,.02)}
  .cal-day-h{font-weight:800;margin-bottom:10px}
  .cal-items{display:flex;flex-direction:column;gap:10px}
  .cal-item{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);cursor:pointer}
  .cal-title{font-weight:700}
  .cal-meta{opacity:.8;font-size:12px;margin-top:4px}
  .cal-badge{display:inline-block;margin-top:8px;padding:4px 10px;border-radius:999px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.25);font-size:12px}
</style>

<!-- ‚úÖ JS tabs -->
<script>
  (function(){
    const tabs = document.querySelectorAll(".tab");
    const panels = document.querySelectorAll(".tab-panel");
    tabs.forEach(t=>{
      t.addEventListener("click", ()=>{
        const key = t.getAttribute("data-tab");
        tabs.forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        panels.forEach(p=>{
          p.style.display = (p.getAttribute("data-panel") === key) ? "" : "none";
        });
      });
    });
  })();
</script>

{% endblock %}

