(function(){
  // --- Panels open/close
  document.addEventListener("click", (e) => {
    const openId = e.target?.getAttribute?.("data-open");
    const closeId = e.target?.getAttribute?.("data-close");
    if(openId){
      document.getElementById(openId)?.classList.add("open");
    }
    if(closeId){
      document.getElementById(closeId)?.classList.remove("open");
    }
  });

  // --- Confirm delete
  document.querySelectorAll(".js-confirm-delete").forEach((f)=>{
    f.addEventListener("submit", (e)=>{
      if(!confirm("Archiver cette carte Trello (Supprimer) ?")){
        e.preventDefault();
      }
    });
  });

  // --- Search + filter
  const q = document.getElementById("q");
  const statusFilter = document.getElementById("statusFilter");
  const cards = () => Array.from(document.querySelectorAll(".js-card"));

  function applyFilters(){
    const term = (q?.value || "").trim().toLowerCase();
    const st = (statusFilter?.value || "").trim();

    cards().forEach(el=>{
      const s = el.getAttribute("data-search") || "";
      const status = el.getAttribute("data-status") || "";
      const okTerm = !term || s.includes(term);
      const okStatus = !st || status === st;
      el.style.display = (okTerm && okStatus) ? "" : "none";
    });
  }

  q?.addEventListener("input", applyFilters);
  statusFilter?.addEventListener("change", applyFilters);

  // --- Compact mode
  const board = document.getElementById("board");
  const btnCompact = document.getElementById("btnCompact");
  btnCompact?.addEventListener("click", ()=>{
    const mode = board?.getAttribute("data-mode") === "compact" ? "normal" : "compact";
    board?.setAttribute("data-mode", mode);
    btnCompact.textContent = (mode === "compact") ? "Vue normale" : "Vue compacte";
  });

  // --- Modal open
  const backdrop = document.getElementById("modalBackdrop");
  const closeBtn = document.getElementById("modalClose");
  const titleEl = document.getElementById("modalTitle");
  const subEl = document.getElementById("modalSub");
  const bodyEl = document.getElementById("modalBody");
  const footEl = document.getElementById("modalFooter");

  function closeModal(){
    backdrop?.classList.remove("open");
    backdrop?.setAttribute("aria-hidden","true");
  }
  closeBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", (e)=>{
    if(e.target === backdrop) closeModal();
  });

  async function openCard(cardId){
    backdrop?.classList.add("open");
    backdrop?.setAttribute("aria-hidden","false");
    titleEl.textContent = "D√©tails r√©servation";
    subEl.textContent = `Card ID: ${cardId}`;
    bodyEl.innerHTML = `<div class="skeleton">Chargement‚Ä¶</div>`;
    footEl.innerHTML = `<button class="btn btn-ghost" type="button" id="close2">Fermer</button>`;
    document.getElementById("close2")?.addEventListener("click", closeModal);

    // üëâ Ici, id√©alement ton backend renvoie un JSON de la carte
    // Si tu n'as pas encore d'endpoint, je te le donne juste apr√®s.
    const urls = [
      `/bookings/api/card/${cardId}`,
      `/bookings/card/${cardId}`
    ];

    let data = null;
    for(const u of urls){
      try{
        const r = await fetch(u, {headers: {"Accept":"application/json"}});
        if(r.ok){
          const ct = r.headers.get("content-type") || "";
          data = ct.includes("application/json") ? await r.json() : {raw: await r.text()};
          break;
        }
      }catch(_){}
    }

    if(!data){
      bodyEl.innerHTML = `<div class="muted">Impossible de charger les d√©tails (endpoint manquant). Dis-moi et je te donne la route Flask.</div>`;
      return;
    }

    if(data.raw){
      bodyEl.innerHTML = `<div>${data.raw}</div>`;
      return;
    }

    const p = data.payload || {};
    const lines = [
      ["Client", p.client_name || ""],
      ["T√©l√©phone", p.client_phone || ""],
      ["Adresse", p.client_address || ""],
      ["V√©hicule", p.vehicle_name || ""],
      ["Plaque", p.vehicle_plate || ""],
      ["Mod√®le", p.vehicle_model || ""],
      ["D√©part", p.start_date || ""],
      ["Retour", p.end_date || ""],
      ["Livraison", p.pickup_location || ""],
      ["Restitution", p.return_location || ""],
      ["Doc", p.doc_id || ""],
      ["Permis", p.driver_license || ""],
      ["Notes", p.notes || ""]
    ];

    bodyEl.innerHTML = `
      <div class="grid2">
        <div class="card" style="padding:14px;">
          <div style="font-weight:900;margin-bottom:10px;">R√©sum√©</div>
          <div class="muted">${data.name || ""}</div>
          <div class="row" style="margin-top:10px; flex-wrap:wrap;">
            <span class="chip">Statut: <b>${data.status || ""}</b></span>
            <span class="chip">Trello: <b>OK</b></span>
          </div>
        </div>

        <div class="card" style="padding:14px;">
          <div style="font-weight:900;margin-bottom:10px;">D√©tails</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${lines.map(([k,v]) => `
              <div style="display:flex;gap:10px;align-items:flex-start;">
                <div style="width:120px;opacity:.75;font-size:12px;">${k}</div>
                <div style="flex:1;font-weight:700;">${(v || "‚Äî")}</div>
              </div>
            `).join("")}
          </div>
        </div>
      </div>
    `;
  }

  document.querySelectorAll(".js-card").forEach((el)=>{
    el.addEventListener("click", ()=>{
      const id = el.getAttribute("data-card-id");
      if(id) openCard(id);
    });
  });

})();

